{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary fw-bold mb-0">
                <i class="fas fa-calendar-alt me-2"></i> Lịch Giảng Dạy Tuần Này
            </h3>
            <p class="text-muted mb-0 mt-1">
                <i class="fas fa-info-circle me-1"></i> Tuần từ <span class="fw-bold text-dark">{{ week_dates[2] }}</span> đến <span class="fw-bold text-dark">{{ week_dates[8] }}</span>
            </p>
        </div>
        <div class="d-flex gap-2">
            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary d-flex align-items-center p-2">
                <i class="fas fa-chalkboard-teacher me-2"></i> Giờ dạy
            </span>
            <span class="badge bg-white text-dark border d-flex align-items-center p-2">
                <i class="fas fa-coffee me-2"></i> Trống
            </span>
        </div>
    </div>

    <div class="card shadow border-0 border-top border-4 border-primary">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle mb-0 table-hover">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th style="width: 10%" class="py-3 text-uppercase small fw-bold">Tiết / Thời gian</th>

                            {% for day in range(2, 9) %}
                            <th style="width: 12%" class="{% if day == today_db %}bg-warning text-dark{% endif %}">
                                <div class="d-flex flex-column py-1">
                                    <span class="fs-6 fw-bold">
                                        {% if day == 8 %}Chủ Nhật{% else %}Thứ {{ day }}{% endif %}
                                    </span>
                                    <span class="small {% if day == today_db %}text-dark fw-bold{% else %}opacity-75 fw-normal{% endif %}">
                                        {{ week_dates[day] }}
                                    </span>
                                </div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {# Định nghĩa khung giờ chuẩn #}
                        {% set times = {
                            1: '07h30 - 08h20', 2: '08h30 - 09h20', 3: '09h30 - 10h20', 4: '10h30 - 11h20', 5: '11h30 - 12h20',
                            6: '13h00 - 13h50', 7: '14h00 - 14h50', 8: '15h00 - 15h50', 9: '16h00 - 16h50', 10: '17h00 - 17h50'
                        } %}

                        {% for lesson in range(1, 11) %}
                        <tr>
                            <td class="bg-light fw-bold text-secondary">
                                <div class="d-flex flex-column justify-content-center">
                                    <span class="fs-6">Tiết {{ lesson }}</span>
                                    <span class="small text-muted fw-normal mt-1" style="font-size: 0.75rem;">
                                        {{ times[lesson] }}
                                    </span>
                                </div>
                            </td>

                            {% for day in range(2, 9) %}
                                {% set ns = namespace(found=false, class_name='', room='', subject='') %}

                                {# Logic tìm lớp học #}
                                {% for cls in my_classes %}
                                    {% for sch in cls.schedules %}
                                        {% if sch.day_of_week == day and lesson >= sch.start_lesson and lesson <= sch.end_lesson %}
                                            {% set ns.found = true %}
                                            {% set ns.class_name = cls.name %}
                                            {% set ns.room = sch.room %}
                                            {% set ns.subject = cls.subject.name %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}

                                {# HIỂN THỊ Ô #}
                                {% if ns.found %}
                                    <td class="p-1">
                                        <div class="p-2 rounded h-100 shadow-sm border border-primary bg-primary bg-opacity-10"
                                             style="border-left-width: 4px !important;">
                                            <strong class="text-primary d-block text-truncate" title="{{ ns.subject }}">
                                                {{ ns.class_name }}
                                            </strong>
                                            <span class="badge bg-white text-dark border mt-1 shadow-sm">
                                                <i class="fas fa-map-marker-alt me-1 text-danger"></i> {{ ns.room }}
                                            </span>
                                        </div>
                                    </td>
                                {% else %}
                                    <td class="{% if day == today_db %}bg-light{% endif %}"></td>
                                {% endif %}
                            {% endfor %}
                        </tr>

                        {# Kẻ vạch ngăn cách Sáng / Chiều #}
                        {% if lesson == 5 %}
                        <tr class="table-secondary">
                            <td colspan="8" class="py-1 text-muted small fw-bold text-uppercase text-center spacing-row">
                                <i class="fas fa-sun me-1"></i> Nghỉ trưa
                            </td>
                        </tr>
                        {% endif %}

                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .table th, .table td { vertical-align: middle; }
    .table-hover tbody tr:hover td { background-color: rgba(0,0,0,0.02); }
    .spacing-row { letter-spacing: 2px; background-color: #e9ecef !important; }
</style>
{% endblock %}