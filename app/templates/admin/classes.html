{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-primary">Quản lý Lớp học phần</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClassModal">
        <i class="fas fa-plus"></i> Thêm Lớp Mới
    </button>
</div>

<div class="card mb-4 shadow-sm border-0 bg-light">
    <div class="card-body">
        <h6 class="fw-bold text-muted mb-3"><i class="fas fa-filter"></i> Bộ lọc & Tìm kiếm:</h6>
        <form method="GET" class="row g-3">

            <div class="col-md-3">
                <select name="semester_id" class="form-select">
                    <option value="">-- Tất cả Học kỳ --</option>
                    {% for sem in semesters %}
                    <option value="{{ sem.id }}"
                        {# Logic: Nếu URL có tham số HOẶC Backend tự chọn (current_filter_sem) #}
                        {% if (request.args.get('semester_id') and request.args.get('semester_id')|int == sem.id)
                              or (not request.args.get('semester_id') and current_filter_sem == sem.id) %}
                            selected
                        {% endif %}>

                        {{ sem.name }} {% if sem.is_active %}(Hiện tại){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <select name="department" class="form-select">
                    <option value="">-- Tất cả Khoa --</option>
                    {% for dept in departments %}
                    <option value="{{ dept[0] }}" {% if request.args.get('department') == dept[0] %}selected{% endif %}>
                        Khoa: {{ dept[0] }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <select name="subject_id" class="form-select">
                    <option value="">-- Tất cả Môn học --</option>
                    {% for sub in subjects %}
                    <option value="{{ sub.id }}" {% if request.args.get('subject_id')|int == sub.id %}selected{% endif %}>
                        {{ sub.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <select name="teacher_id" class="form-select">
                    <option value="">-- Tất cả Giảng viên --</option>
                    {% for t in teachers %}
                    <option value="{{ t.id }}" {% if request.args.get('teacher_id')|int == t.id %}selected{% endif %}>
                        {{ t.user.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 text-end">
                <a href="{{ url_for('admin.manage_classes') }}" class="btn btn-outline-secondary me-2">Đặt lại</a>
                <button type="submit" class="btn btn-primary px-4"><i class="fas fa-search"></i> Tìm kiếm</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Tên lớp</th>
                    <th>Môn học</th>
                    <th>Giảng viên</th>
                    <th>Học kỳ</th>
                    <th>Sĩ số</th>
                    <th>Cấu hình</th> <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                {% for cls in classes %}
                <tr>
                    <td>{{ cls.id }}</td>
                    <td class="fw-bold text-primary">{{ cls.name }}</td>
                    <td>
                        {{ cls.subject.name }} <br>
                        <small class="text-muted">{{ cls.subject.credits }} tín chỉ</small>
                    </td>
                    <td>
                        {{ cls.teacher.user.full_name }} <br>
                        <small class="text-muted">{{ cls.teacher.department }}</small>
                    </td>
                    <td>{{ cls.semester.name }}</td>
                    <td>{{ cls.enrollments|length }}/{{ cls.max_students }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info"
                                onclick="openScheduleModal('{{ cls.id }}', '{{ cls.name }}')">
                            <i class="fas fa-calendar-alt"></i> Lịch dạy
                        </button>
                    </td>
                    <td>
                        {% if cls.is_locked %}
                            <span class="badge bg-danger">Đã khóa</span>
                        {% else %}
                            <span class="badge bg-success">Đang học</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">Không tìm thấy lớp học phần nào phù hợp.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addClassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-plus-circle"></i> Tạo Lớp Học Phần Mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="POST" action="{{ url_for('admin.manage_classes') }}">
                <div class="modal-body">
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Học kỳ <span class="text-danger">*</span></label>
                            <select class="form-select" name="semester_id" id="select-semester" required>
                                <option value="" selected disabled>-- Chọn học kỳ --</option>
                                {% for sem in semesters %}
                                    <option value="{{ sem.id }}" {% if not sem.is_active %}disabled class="text-muted bg-light"{% endif %}>
                                        {{ sem.name }} {% if not sem.is_active %}(Đã khóa){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Môn học <span class="text-danger">*</span></label>
                            <select class="form-select" name="subject_id" id="select-subject" required>
                                <option value="" selected disabled data-name="">-- Chọn môn học --</option>
                                {% for sub in subjects %}
                                    <option value="{{ sub.id }}" data-name="{{ sub.name }}">
                                        {{ sub.name }} ({{ sub.code }}) - {{ sub.credits }} TC
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-bold">Tên lớp học phần <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-signature"></i></span>
                                <input type="text" class="form-control fw-bold text-primary"
                                       name="name" id="input-name"
                                       placeholder="Chọn Học kỳ và Môn học để tạo tên..." required>
                            </div>
                            <div class="form-text text-muted">
                                <i class="fas fa-magic"></i> Tên lớp tự động: [Tên Môn] - Nhóm [Số thứ tự].
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Sĩ số tối đa</label>
                            <input type="number" class="form-control" name="max_students" value="60" min="10" max="200" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Giảng viên phụ trách <span class="text-danger">*</span></label>
                            <select class="form-select" name="teacher_id" required>
                                <option value="" selected disabled>-- Chọn giảng viên --</option>
                                {% for t in teachers %}
                                    <option value="{{ t.id }}">{{ t.user.full_name }} ({{ t.department }})</option>
                                {% endfor %}
                            </select>
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Lưu Lớp Học</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> Cấu hình lịch: <span id="scheduleClassName" class="fw-bold text-dark"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <div class="card card-body bg-light mb-3 p-2 border-0">
                    <h6 class="fw-bold text-primary mb-2 small text-uppercase">Thêm buổi học:</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col-3">
                            <label class="small fw-bold">Thứ</label>
                            <select id="sch-day" class="form-select form-select-sm">
                                <option value="2">Hai</option>
                                <option value="3">Ba</option>
                                <option value="4">Tư</option>
                                <option value="5">Năm</option>
                                <option value="6">Sáu</option>
                                <option value="7">Bảy</option>
                                <option value="8">CN</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="small fw-bold">Tiết BĐ</label>
                            <input type="number" id="sch-start" class="form-control form-control-sm" min="1" max="15" placeholder="1">
                        </div>
                        <div class="col-3">
                            <label class="small fw-bold">Số tiết</label>
                            <input type="number" id="sch-count" class="form-control form-control-sm" min="1" max="5" value="3">
                        </div>
                        <div class="col-3">
                            <label class="small fw-bold">Phòng</label>
                            <input type="text" id="sch-room" class="form-control form-control-sm" placeholder="A101">
                        </div>
                        <div class="col-12 text-end mt-2">
                            <button onclick="addSchedule()" class="btn btn-sm btn-primary w-100"><i class="fas fa-plus"></i> Thêm Lịch</button>
                        </div>
                    </div>
                    <div id="sch-error" class="text-danger small mt-2 fw-bold text-center"></div>
                </div>

                <h6 class="fw-bold border-bottom pb-2 mt-3">Lịch đã xếp:</h6>
                <div id="scheduleList" class="list-group list-group-flush">
                    <p class="text-center text-muted my-3">Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- PHẦN 1: TỰ ĐỘNG TẠO TÊN LỚP (MODAL THÊM LỚP) ---
    document.addEventListener('DOMContentLoaded', function() {
        const semesterSelect = document.getElementById('select-semester');
        const subjectSelect = document.getElementById('select-subject');
        const nameInput = document.getElementById('input-name');

        function updateClassName() {
            const semesterId = semesterSelect.value;
            const subjectId = subjectSelect.value;
            const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
            const subjectName = selectedOption.getAttribute('data-name');

            if (semesterId && subjectId && subjectName) {
                nameInput.placeholder = "Đang lấy dữ liệu...";
                fetch(`/admin/api/get_next_group?semester_id=${semesterId}&subject_id=${subjectId}`)
                    .then(response => response.json())
                    .then(data => {
                        nameInput.value = `${subjectName} - Nhóm ${data.next_group}`;
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        semesterSelect.addEventListener('change', updateClassName);
        subjectSelect.addEventListener('change', updateClassName);
    });

    // --- PHẦN 2: QUẢN LÝ LỊCH HỌC (AJAX) ---
    let currentClassId = null;

    // A. Mở Modal và load dữ liệu
    function openScheduleModal(classId, className) {
        currentClassId = classId;
        document.getElementById('scheduleClassName').innerText = className;
        document.getElementById('sch-error').innerText = '';
        document.getElementById('sch-start').value = '';
        document.getElementById('sch-room').value = '';

        const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        modal.show();

        loadSchedules(classId);
    }

    // B. Load danh sách từ Server
    function loadSchedules(classId) {
        const listContainer = document.getElementById('scheduleList');
        listContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';

        fetch(`/admin/api/schedule/get/${classId}`)
            .then(res => res.json())
            .then(data => {
                listContainer.innerHTML = '';
                if (data.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-muted fst-italic py-3">Chưa có lịch học nào.</div>';
                    return;
                }

                data.forEach(sch => {
                    let dayText = sch.day === 8 ? "Chủ Nhật" : "Thứ " + sch.day;
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center px-0';
                    item.innerHTML = `
                        <div>
                            <i class="far fa-clock text-muted me-2"></i>
                            <span class="fw-bold text-dark">${dayText}</span>:
                            Tiết <span class="badge bg-secondary">${sch.start} -> ${sch.end}</span>
                            - Phòng <span class="fw-bold text-primary">${sch.room}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteSchedule(${sch.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            });
    }

    // C. Thêm lịch mới
    function addSchedule() {
        const day = document.getElementById('sch-day').value;
        const start = document.getElementById('sch-start').value;
        const count = document.getElementById('sch-count').value;
        const room = document.getElementById('sch-room').value;
        const errorDiv = document.getElementById('sch-error');

        if (!start || !room) {
            errorDiv.innerText = 'Vui lòng nhập tiết bắt đầu và phòng học!';
            return;
        }

        fetch('/admin/api/schedule/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                class_id: currentClassId,
                day: day, start: start, count: count, room: room
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                errorDiv.innerText = '';
                document.getElementById('sch-room').value = '';
                loadSchedules(currentClassId);
            } else {
                errorDiv.innerText = data.msg;
            }
        })
        .catch(err => {
            errorDiv.innerText = "Lỗi kết nối server!";
        });
    }

    // D. Xóa lịch
    function deleteSchedule(schId) {
        if(!confirm('Xác nhận xóa buổi học này?')) return;

        fetch('/admin/api/schedule/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ schedule_id: schId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                loadSchedules(currentClassId);
            }
        });
    }
</script>

{% endblock %}